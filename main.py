import asyncio  # å¯¼å…¥å¼‚æ­¥IOåº“ï¼Œç”¨äºå®ç°å¼‚æ­¥ç¼–ç¨‹
#import json  # å¯¼å…¥JSONå¤„ç†åº“ï¼Œç”¨äºè§£æå’Œåºåˆ—åŒ–JSONæ•°æ®
import os  # å¯¼å…¥æ“ä½œç³»ç»Ÿæ¨¡å—ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºè¯»å–ç¯å¢ƒå˜é‡æ–‡ä»¶
#import re  # å¯¼å…¥æ­£åˆ™è¡¨è¾¾å¼ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºè§£æGithubæ–‡æ¡£çš„markdownæ ¼å¼å†…å®¹
#import webbrowser  # å¯¼å…¥webæµè§ˆå™¨æ¨¡å—ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­ç”¨æˆ·æ‰“å¼€ä¸€ä¸ªwebé¡µé¢å±•ç¤ºç¿»è¯‘åçš„æ–‡æ¡£å†…å­˜
#import tempfile  # å¯¼å…¥ä¸´æ—¶æ–‡ä»¶æ¨¡å—ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºåˆ›å»ºä¸€ä¸ªä¸´æ—¶é—®æ–‡ä»¶å¤¹
#import markdown  # å¯¼å…¥markdownåº“ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºæ ¼å¼åŒ–æ–‡æ¡£çš„å†…å®¹å¹¶æ˜¾ç¤º
import traceback  # ç”¨äºæ•è·å’Œæ‰“å°è¯¦ç»†çš„å¼‚å¸¸ä¿¡æ¯
from typing import Any  # å¯¼å…¥ç±»å‹æç¤ºå·¥å…·ï¼Œå¢å¼ºä»£ç çš„æç¤ºå®‰å…¨ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºæ ‡è®°å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹

from mcp import stdio_client

"""
OpenAI agents SKD ç›¸å…³å¯¼å…¥
"""
from agents import (
    Agent,  # agentç±»ï¼Œç”¨äºå®šä¹‰å’Œæ‰§Agentä»»åŠ¡ï¼Œæœ¬é¡¹ç›®ä¸­æˆ‘ä»¬éœ€è¦æ„å»ºæµè§ˆå™¨ï¼Œæ–‡æ¡£å¤„ç†å’Œæ§åˆ¶å™¨ä»£ç†ã€
    Model,  # Modelç±»ï¼Œ ç”¨äºå®šä¹‰æˆ‘ä»¬è‡ªå®šä¹‰çš„æ¨¡å‹æä¾›å•†å‡½æ•°è¿”å›çš„ç±»å‹
    ModelSettings,  # ModelSettingç±»ï¼Œ ç”¨äºé…ç½®æ¨¡å‹å‚æ•°ï¼Œ å¦‚æ¸©åº¦ç­‰ï¼Œ åœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºè°ƒæ•´å„ä»£ç†çš„è¡Œä¸ºç‰¹å¾
    Runner,  # åœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºå¯åŠ¨å’Œåè°ƒ agent
    RunConfig,  # åœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºé…ç½®å’Œè¿è¡Œç¯å¢ƒå’Œè¿½è¸ªé€‰é¡¹
    set_tracing_disabled,  # åœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºç¦ç”¨è¿½è¸ªåŠŸèƒ½çš„å‡½æ•°ï¼Œé¿å…å‘é€æ•°æ®åˆ°OpenAI
    #function_tool,  # åœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºåˆ›å»ºä¸€ä¸ªmarkdownæµè§ˆå™¨å·¥å…·è®©agentä½¿ç”¨
    ModelProvider,  # åœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºå®ç° DeepSeek API å…¼å®¹çš„å®ä¾‹
    OpenAIChatCompletionsModel,  # åœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºè¿æ¥DeepSeek API
    RunContextWrapper,  # åœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºé’©å­å‡½æ•°å‚æ•°çš„ç±»å‹è¿›è¡Œå®šä¹‰
    AgentHooks,  # agent ç”Ÿå‘½å‘¨æœŸé’©å­æ¥å£ï¼Œ ç”¨äºç›‘æ§å’Œå¹²é¢„ agent æ‰§è¡Œè¿‡ç¨‹ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºè¿½è¸ªæ‰§è¡Œè¿›åº¦å’Œæå–æ‰§è¡Œç»“æœ
)
from agents.mcp import MCPServerStdio  # ä½¿ç”¨æœ¬åœ°é€šä¿¡ï¼Œæ ‡å‡†åŒ–è¾“å…¥è¾“å‡ºä¸æœ¬åœ° MCP é€šä¿¡ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­åˆ›å»ºPlaywright MCP æœåŠ¡çš„è¿æ¥
from openai import AsyncOpenAI  # å¯¼å…¥OpenAIå¼‚æ­¥å®¢æˆ·ç«¯ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºåˆ›å»ºDeepSeek API çš„å¼‚æ­¥é€šä¿¡å®¢æˆ·ç«¯
from dotenv import load_dotenv  # å¯¼å…¥dotenv, åœ¨æœ¬é¡¹ç›®ä¸­ç”¨äºåŠ è½½ç¯å¢ƒå˜é‡


load_dotenv()  # åŠ è½½ç¯å¢ƒå˜é‡

# ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–è¿™äº›å€¼
API_KEY = os.getenv("API_KEY")
BASE_URL = os.getenv("BASE_URL")
MODEL_NAME = os.getenv("MODEL_NAME")
Gao_De_API = os.getenv("Gao_De_API")  # é«˜å¾·åœ°å›¾çš„API
AMAP_MAPS_API_KEY = os.getenv("AMAP_MAPS_API_KEY")
AP_APP_ID = os.getenv("AP_APP_ID")#æ”¯ä»˜å®
AP_APP_KEY = os.getenv("AP_APP_KEY")#æ”¯ä»˜å®
AP_PUB_KEY = os.getenv("AP_PUB_KEY")#æ”¯ä»˜å®

# éªŒè¯å‚æ•°æ˜¯å¦å­˜åœ¨
if not API_KEY:
    raise ValueError("API_KEY is not set")
if not BASE_URL:
    raise ValueError("BASE_URL is not set")
if not MODEL_NAME:
    MODEL_NAME = "deepseek-chat"

# ç”¨OpenAIçš„å‡½æ•°æŒ‡å‘deepseek
client = AsyncOpenAI(
    base_url=BASE_URL,
    api_key=API_KEY,
)

# åˆ›å»ºæ¨¡å‹æä¾›å•†çš„ç±»
class DeepSeekModelProvider(ModelProvider):
    """
    è‡ªå®šä¹‰æ¨¡å‹æä¾›å•†

    å®ç°ModerProvideræ¥å£ï¼Œæä¾›è‡ªå®šä¹‰çš„æ¨¡å‹å®ä¾‹
    è¿™ä½¿åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨DeepSeekç­‰äºOpenAIå…¼å®¹çš„APIæ›¿ä»£åŸç”Ÿopenaiæ¥å£
    åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œä»–ä½œä¸ºæ‰€æœ‰agentsä¸æ¨¡å‹äº¤äº’çš„ç»Ÿä¸€å…¥å£ï¼Œç¡®ä¿ä¸€è‡´æ€§çš„æ¨¡å‹è¡Œä¸º
    """

    # å®ç°ModelProvideræ¥å£çš„get_modelæ–¹æ³•
    def get_model(self, model_name: str) -> Model:
        """
        è·å–æ¨¡å‹å®ä¾‹
        æ ¹æ®æä¾›çš„æ¨¡å‹åç§°ï¼Œèˆ¹èˆ°å¹¶è¿”å›ä¸€ä¸ªæ¨¡å‹å®ä¾‹
        è¿”å›çš„æ˜¯ä¸OpenAIå…¼å®¹çš„å®ä¾‹
        """
        return OpenAIChatCompletionsModel(
            model=model_name,
            openai_client=client
        )

# åˆ›å»ºæ¨¡å‹æä¾›å•†å®ä¾‹
# è¿™ä¸ªå®ä¾‹å°†ä½œç”¨äºæ‰€æœ‰Agent
model_provider = DeepSeekModelProvider()

# è¿™æ˜¯ä¸ºäº†é˜²æ­¢ SDKé»˜è®¤å‘OPENAIå‘é€è¿½è¸ªæ•°æ®è¿›è¡Œagentè°ƒè¯•ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯deepseek APIï¼Œæ˜¯æ²¡æœ‰open APIå¯†é’¥çš„ï¼Œé˜²æ­¢ä»–è‡ªåŠ¨å‘é€ç»™openAI
set_tracing_disabled(True)

class GaodeHooks(AgentHooks):
    async def on_start(self, context: RunContextWrapper, agent: Agent) -> None:
        """
        åœ¨ agent å¼€å§‹æ‰§è¡Œçš„æ—¶å€™è°ƒç”¨
        """
        print(f"[ä½ çš„æ—…è¡ŒåŠ©æ‰‹] agent {agent.name} å¼€å§‹æ‰§è¡Œ...")
    async def on_end(self, context: RunContextWrapper, agent: Agent, output: Any) -> None:
        """
        å½“ agent ç»“æŸè¿è¡Œæ—¶è§¦å‘
        """
        print(f"[ä½ çš„æ—…è¡ŒåŠ©æ‰‹] agent {agent.name} å®Œæˆæ‰§è¡Œï¼Œæ‰§è¡Œç»“æœï¼š \n {output[:300]}")

class BrowserAgentHooks(AgentHooks):
    """
    ç”¨äºç›‘æ§æµè§ˆå™¨agentæ‰§è¡Œçš„é’©å­

    è¿™ä¸ªç±»å®ç°äº† AgentHooks æ¥å£ï¼Œç”¨äºç›‘æ§å’Œå¤„ç†æµè§ˆå™¨agentçš„ç”Ÿå‘½å‘¨æœŸæ—¶é—´
    åªè¦åŠŸèƒ½æ˜¯ï¼š
    1.è·Ÿè¸ªagentæ‰§è¡Œå¼€å§‹ç»“æœ
    2.è§£æagentè¿”å›çš„markdownæ ¼å¼æ•°æ®

    åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œä»–æ˜¯è¿æ¥æµè§ˆå™¨agentå’Œé«˜å¾·agentçš„å…³é”®ç¯èŠ‚ï¼Œè´Ÿè´£ä»æµè§ˆå™¨ä»£ç†è¿”å›ç»“æœä¸­æå–ç»“æ„åŒ–æ•°æ®
    """
    def __init__(self):
         super().__init__()

    async def on_start(self, context: RunContextWrapper, agent: Agent) -> None:
        """
        åœ¨ agent å¼€å§‹æ‰§è¡Œçš„æ—¶å€™è°ƒç”¨
        """
        print(f"[æµè§ˆå™¨ä»£ç†] agent {agent.name} å¼€å§‹æ‰§è¡Œ...")
    async def on_end(self, context: RunContextWrapper, agent: Agent, output: Any) -> None:
        """
        å½“ agent ç»“æŸè¿è¡Œæ—¶è§¦å‘
        """
        print(f"[æµè§ˆå™¨ä»£ç†] agent {agent.name} å®Œæˆæ‰§è¡Œã€‚æ‰§è¡Œç»“æœï¼š\n{output[:300]}")

async def create_browser_agent():
    """
    åˆ›å»ºæµè§ˆå™¨äº¤äº’Agent
    è¿™ä¸ªå‡½æ•°è´Ÿè´£åˆå§‹åŒ–å’Œé…ç½®æµè§ˆå™¨äº¤äº’agent åŒ…æ‹¬ï¼š
    1.åˆ›å»º playwright MCP æœåŠ¡å™¨è¿æ¥å®ä¾‹
    2.é…ç½®æµè§ˆå™¨agent,åŒ…æ‹¬æŒ‡ä»¤æŒ‡ä»¤å’Œæ¨¡å‹è®¾ç½®
    3.è®¾ç½®ç›‘æ§é’©å­æ˜¾ç¤ºæ‰§è¡Œç»“æœ

    æµè§ˆå™¨agentè´Ÿè´£ä½¿ç”¨playwrightæ‰“å¼€æµè§ˆå™¨è®¿é—®é«˜å¾·åœ°å›¾,è®¿é—®ç”¨æˆ·è¯¢é—®çš„æœ‰å…³è¯»ç‚¹è·¯çº¿é—®é¢˜
    åœ¨æœ¬ç¨‹åºä¸­ï¼Œæ­¤å‡½æ•°åˆ›å»ºäº†è´Ÿè´£ç½‘ç»œäº¤äº’çš„agent, æ˜¯æ•´ä¸ªå·¥ä½œæµçš„ç¬¬ä¸€ä¸ªå…³é”®ç»„ä»¶
    returns:
       tuple:åŒ…å«ä¸¤ä¸ªå…ƒç´ çš„å…ƒç»„
       1.Agent:é…ç½®å¥½çš„æµè§ˆå™¨äº¤äº’ä¸ºagentå®ä¾‹
       2.MCP :playwright MCP æœåŠ¡å™¨è¿æ¥å®ä¾‹
    """
    # åˆ›å»ºplaywright MCPæœåŠ¡è¿æ¥å®ä¾‹ï¼Œä½¿ç”¨ MCPServerStdio æ ‡å‡†è¾“å…¥è¾“å‡º
    playwright_server = MCPServerStdio(
        name="playwright",
        params={
            "command": "npx",  # è¿è¡Œnpxå‘½ä»¤ï¼Œç”¨äºæ‰§è¡Œplaywright MCP æœåŠ¡
            "args": ["-y", "@playwright/mcp@latest"],  # å¯ç”¨æœ€æ–°ç‰ˆçš„playwright MCPæœåŠ¡
            "env": {}  # ç¯å¢ƒå˜é‡ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­ä¸éœ€è¦é¢å¤–é…ç½®
        },
        cache_tools_list=True  # å¯ç”¨å·¥å…·ç¼“å­˜ï¼Œå‡å°‘é‡å¤è¿è¡Œ MCPæœåŠ¡è¿è¡Œå·¥å…·åˆ—è¡¨æŸ¥è¯¢çš„å¼€é”€
    )

    try:
        # è¿æ¥playwright MCP æœåŠ¡
        print("æ­£åœ¨è¿æ¥ playwright MCP æœåŠ¡...")
        await playwright_server.connect()
        print("playwright MCP æœåŠ¡è¿æ¥æˆåŠŸ")

        # è·å– MCPæœåŠ¡å¯ç”¨å·¥å…·åˆ—è¡¨
        tools = await playwright_server.list_tools()
        print(f"playwright MCP æœåŠ¡å¯ç”¨å·¥å…·åˆ—è¡¨{len(tools)}")

        # åˆ›å»ºæµè§ˆå™¨ agent é’©å­
        # ç”¨äºç›‘æ§å’Œå¤„ç†å…­æ‹‰èµ·çš„æ‰§è¡Œè¿‡ç¨‹å’Œç»“æœï¼Œåœ¨é¡¹ç›®ä¸­ä½œä¸ºagentç”Ÿå‘½å‘¨æœŸçš„ç›‘æ§ç»„ä»¶
        browser_hooks = BrowserAgentHooks()

        # åˆ›å»ºæµè§ˆå™¨agent
        # é…ç½®ä¸€ä¸ªä¸“é—¨ç”¨äºæ‰“å¼€ç™¾åº¦åœ°å›¾ç½‘é¡µçš„æ™ºèƒ½ä½“ï¼Œå¸®åŠ©æˆ‘ä»¬æ‰“å¼€ç™¾åº¦åœ°å›¾
        browser_agent = Agent(
            name="GaoDeDocumentBrowser",  # ä»£ç†åç§°ï¼Œä½œä¸ºä»£ç†çš„å”¯ä¸€æ ‡è¯†ç¬¦
            # è¯¦ç»†çš„agentæŒ‡å¯¼ï¼ŒæŒ‡å¯¼è¿™ä¸ªagentåœ¨ç™¾åº¦åœ°å›¾ä¸Šè¿›è¡Œè·¯çº¿æ£€ç´¢ï¼Œåœ¨é¡¹ç›®ä¸­ä½œä¸ºä¸€ä¸ªagentçš„æ‰§è¡Œç­–ç•¥å’Œè¡Œä¸ºè§„åˆ’
            instructions="""
            ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é«˜å¾·åœ°å›¾è§„åˆ’ä¸“å®¶ï¼Œä½ çš„ä»»åŠ¡æ˜¯ä½¿ç”¨æµè§ˆå™¨å·¥å…·è®¿é—®é«˜å¾·åœ°å›¾,æœç´¢ç”¨æˆ·æŒ‡å®šçš„æŠ€æœ¯å…³é”®è¯ï¼Œå¹¶æå–æœ€æƒå¨ï¼Œæœ€ç›´æ¥ç›¸å…³çš„å®˜æ–¹ä»“åº“æ–‡æ¡£å†…å®¹
            æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å·¥ä½œï¼š
            ##æœ€é‡è¦çš„äº‹æƒ…##ï¼šä¸è¦ç‚¹å‡»ç½‘é¡µå†…çš„å›¾ç‰‡ï¼Œä¸è¦ç‚¹å‡»ç›¸å†Œå†…çš„æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯imgæ–‡ä»¶ã€‚
            1.å¯¼èˆªåˆ°ç™¾åº¦åœ°å›¾(https://map.baidu.com)ç½‘é¡µ
            2.ä½¿ç”¨å¹³å°å†…çš„æœç´¢åŠŸèƒ½ï¼Œæ³¨æ„ç”¨æˆ·æ˜¯è¯¢é—®ä¸€ä¸ªæ™¯ç‚¹çš„é—®é¢˜ï¼Œè¿˜æ˜¯è¯¢é—®è¿™ä¸ªæ™¯ç‚¹é™„è¿‘çš„æ™¯ç‚¹çš„é—®é¢˜ï¼Œç†è§£åå†æŠŠé—®é¢˜è¾“å…¥åˆ°å¹³å°å†…çš„æœç´¢æ ä¸­
            3.æ ¹æ®ç”¨æˆ·ä¿¡æ¯ï¼Œåœ¨ç½‘é¡µå†…å¾—åˆ°æ’åºåçš„å„ä¸ªæ™¯ç‚¹åï¼Œä¾æ¬¡ç‚¹å‡»è¿™å‡ ä¸ªæ™¯ç‚¹å±•ç°ç»™ç”¨æˆ·
            4.ç¦æ­¢ç‚¹å‡»ç½‘é¡µå†…çš„å›¾ç‰‡
            æ³¨æ„ï¼šä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯è·å–æ–‡æ¡£å¹¶æŒ‰æ ¼å¼è¿”å›ç»“æœï¼Œ ä¸è¦å°è¯•æ‰§è¡Œé¢å¤–çš„ä»»åŠ¡æˆ–åŠ¨ç”¨å…¶ä»–ä»£ç†ï¼Œ
            **è¿”å›æ ¼å¼ï¼ˆå¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„ï¼‰ï¼š**
            
            **å¦‚æœç”¨æˆ·è¯¢é—®çš„æ˜¯é…’åº—çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆæŒ‰ç…§ä¸‹åˆ—æ ¼å¼
                --------è¿”å›å†…å®¹ä»è¿™é‡Œå¼€å§‹--------
                ## é…’åº—çš„ä¿¡æ¯ï¼š
                **é…’åº—çš„åå­—**
                 - åœ°å€:[]
                 - è¯„åˆ†:[â€œæ²¡æœ‰å°±å¡«å†™æ— â€]
                 - ä»‹ç»:["æ²¡æœ‰å°±å†™æ— "]
                --------è¿”å›å†…å®¹åˆ°è¿™é‡Œç»“æŸ--------
            **å¦‚æœç”¨æˆ·è¯¢é—®çš„æ˜¯å…³äºæ™¯ç‚¹è·¯çº¿è§„åˆ’çš„é—®é¢˜
                --------è¿”å›å†…å®¹ä»è¿™é‡Œå¼€å§‹--------
                ## æ™¯ç‚¹çš„ä¿¡æ¯ï¼š
                  **æ™¯ç‚¹åç§°**  
                  - åœ°å€ï¼š[] 
                  - ç‰¹è‰²ï¼š[]
                  - è¯„åˆ†ï¼š[â€œæ²¡æœ‰å°±å¡«å†™æ— â€]  
                  - é—¨ç¥¨ï¼š[â€œæ²¡æœ‰å°±å¡«å†™å…è´¹â€]  
                ##è·¯çº¿è§„åˆ’
                æ€»ä½“çš„è·¯çº¿è§„åˆ’ï¼šç¬¬ä¸€ä¸ªæ™¯ç‚¹çš„åç§° -> ç¬¬äºŒä¸ªæ™¯ç‚¹çš„åç§° ->...->æœ€åä¸€ä¸ªæ™¯ç‚¹çš„åç§°
                ##è¯¦ç»†è·¯çº¿
                  **æ™¯ç‚¹åç§°** -> **æ™¯ç‚¹åç§°**:
                  - æ­¥è¡Œè·ç¦»ï¼š[]ç±³ï¼Œçº¦[]åˆ†é’Ÿ
                  - è·¯çº¿è§„åˆ’ï¼šå…·ä½“è¦æ€ä¹ˆèµ°çš„å¯¼èˆªå†…å®¹
                 ##å¤©æ°”
                  **å¤©æ°”æƒ…å†µï¼šï¼ˆè¾“å‡ºç”¨æˆ·è¯¢é—®æ¶ˆæ¯å½“å¤©çš„å¤©æ°”ä¿¡æ¯ï¼‰
                --------è¿”å›å†…å®¹åˆ°è¿™é‡Œç»“æŸ--------
                **é‡è¦é™åˆ¶å’Œè¯´æ˜:**
                1.ä¸¥æ ¼æŒ‰ç…§ä¸Šé¢çš„æ ¼å¼è¿”å›ä¿¡æ¯ã€‚ä¸è¦æ·»åŠ é¢å¤–çš„è¯´æ˜çš„è§£é‡Š
                2.å¾—åˆ°äº†å¤šä¸ªåœ°ç‚¹ï¼Œé‚£ä¹ˆæŒ‰å…ˆè¿‘åè¿œçš„é¡ºåºï¼Œä»¥->æ¥è¿æ¥ä¸åŒçš„åœ°ç‚¹ä½ç½®ï¼Œç„¶åç»™å‡ºä»ç¬¬ä¸€ä¸ªåœ°ç‚¹ä¾æ¬¡åˆ°æœ€åä¸€ä¸ªåœ°ç‚¹çš„è·¯çº¿è§„åˆ’ï¼Œä¸€å®šè¦ç”¨->æ¥è¿æ¥ä¸åŒçš„åœ°ç‚¹
                3.æ³¨æ„è¦è¿”å›ä¸€ä¸ªæ€»ä½“çš„è·¯çº¿è§„åˆ’ï¼Œä»è¿‘åˆ°è¿œï¼Œä¾æ¬¡è¿æ¥æ¯ä¸€ä¸ªæ™¯ç‚¹
                4.ä¸Gaode_agentä¸€èµ·å®Œæˆè¿™ä¸ªä»»åŠ¡
            **é‡è¦é™åˆ¶å’Œè¯´æ˜:**
            1.ä¸¥æ ¼æŒ‰ç…§ä¸Šé¢çš„æ ¼å¼è¿”å›ä¿¡æ¯ã€‚ä¸è¦æ·»åŠ é¢å¤–çš„è¯´æ˜çš„è§£é‡Š
            2.ä¸è¦ç‚¹å‡»ç½‘é¡µå†…çš„å›¾ç‰‡ï¼Œä¸èƒ½ç‚¹å‡»ç½‘é¡µå†…çš„å›¾ç‰‡
           """,
            mcp_servers=[playwright_server],  # å…³è”MCPæœåŠ¡å™¨ï¼Œæä¾›æµè§ˆå™¨è‡ªåŠ¨åŒ–èƒ½åŠ›
            hooks=browser_hooks,  # æ·»åŠ æµè§ˆå™¨ agent é’©å­ï¼Œç”¨äºç›‘æ§å’Œå¤„ç†æµè§ˆå™¨ agent çš„æ‰§è¡Œè¿‡ç¨‹å’Œç»“æœ
            model=model_provider.get_model(MODEL_NAME),  # ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„æ¨¡å‹æä¾›å•†ï¼Œç¡®ä¿agentä½¿ç”¨æ­£ç¡®çš„æ¨¡å‹
            model_settings=ModelSettings(
                temperature=0.3,  # è®¾ç½®æ¸©åº¦å€¼
                top_p=0.9,  # è®¾ç½®è¯æ±‡å¤šæ ·æ€§
                tool_choice="auto"  # è®¾ç½®å·¥å…·é€‰æ‹©ç­–ç•¥
            )
        )
        return browser_agent, playwright_server
    except Exception as e:
        print(f"åˆ›å»ºæµè§ˆå™¨ agent æ—¶å‘ç”Ÿå¼‚å¸¸: {e}")
        await playwright_server.cleanup()  # ç¡®ä¿æ¸…ç†MCPæœåŠ¡å™¨èµ„æºï¼Œé˜²æ­¢èµ„æºæ³„éœ²å’Œè¿›ç¨‹æ®‹ç•™

async def create_Gaode_agent():
    """
    åˆ›å»ºæ—…è¡Œè·¯çº¿ç­‰è§„åˆ’agent,è°ƒç”¨é«˜å¾·åœ°å›¾çš„MCPï¼Œæ¥å›ç­”ç”¨æˆ·çš„å…³äºæ—…è¡Œçš„ä¸€äº›é—®é¢˜
    è¿™ä¸ªå‡½æ•°è´Ÿè´£å›ç­”ç”¨æˆ·çš„æ—…è¡Œé—®é¢˜ç”¨æ³•ï¼›
    1.ä»ç”¨æˆ·çš„é—®é¢˜ä¸­åˆ†ææ˜¯ä¸æ˜¯è¦è¿›è¡Œæ—…è¡Œè§„åˆ’
    2.è°ƒç”¨é«˜å¾·çš„MCPå·¥å…·
    3.ä»è€Œè¾“å‡ºï¼Œä»¥è§„èŒƒçš„è¯­è¨€è¾“å‡º
    """
    Gaode_server = MCPServerStdio(
        name="amap-maps",
        params={
            # "description": "é«˜å¾·mcp",
            # "isActive": True,
            "command": "npx",
            "args": [
                "-y",
                "@amap/amap-maps-mcp-server"
            ],
            "env": {
                "AMAP_MAPS_API_KEY": f"{AMAP_MAPS_API_KEY}"
            }
        },
        cache_tools_list=True
    )
    try:
        # è¿æ¥Gaode MCP æœåŠ¡
        print("æ­£åœ¨è¿æ¥ Gaode MCP æœåŠ¡...")
        await Gaode_server.connect()
        print("Gaode MCP æœåŠ¡è¿æ¥æˆåŠŸ")

        # è·å– MCPæœåŠ¡å¯ç”¨å·¥å…·åˆ—è¡¨
        tools = await Gaode_server.list_tools()
        print(f"Gaode MCP æœåŠ¡å¯ç”¨å·¥å…·åˆ—è¡¨{len(tools)}")

        # åˆ›å»ºé«˜å¾·åœ°å›¾ agent é’©å­
        # ç”¨äºç›‘æ§å’Œå¤„ç†å…­æ‹‰èµ·çš„æ‰§è¡Œè¿‡ç¨‹å’Œç»“æœï¼Œåœ¨é¡¹ç›®ä¸­ä½œä¸ºagentç”Ÿå‘½å‘¨æœŸçš„ç›‘æ§ç»„ä»¶
        Gaode_hooks = GaodeHooks()
        # åˆ›å»ºé«˜å¾·åœ°å›¾agent
        # é…ç½®ä¸€ä¸ªä¸“é—¨ç”¨äºé«˜å¾·åœ°å›¾æ£€ç´¢è·¯çº¿è§„åˆ’çš„æ™ºèƒ½ä½“ï¼Œåœ¨é¡¹ç›®ä¸­è´Ÿè´£è¾“å‡ºå…³äºæ—…è¡Œçš„ä¸€äº›å»ºè®®
        Gaode_agent = Agent(
            name="Gaode_map",  # ä»£ç†åç§°ï¼Œä½œä¸ºä»£ç†çš„å”¯ä¸€æ ‡è¯†ç¬¦
            # è¯¦ç»†çš„agentæŒ‡å¯¼ï¼ŒæŒ‡å¯¼è¿™ä¸ªagentåœ¨é«˜å¾·åœ°å›¾è¿›è¡Œæ£€ç´¢ï¼Œåœ¨é¡¹ç›®ä¸­è´Ÿè´£è¾“å‡ºè·¯çº¿ä¿¡æ¯
            instructions="""
            ä½ æ˜¯é«˜å¾·åœ°å›¾é¢†åŸŸä¸“å®¶ Agentï¼Œèƒ½å¤Ÿç²¾å‡†ä¸”å…¨é¢åœ°è§£ç­”ä¸é«˜å¾·åœ°å›¾ç›¸å…³çš„å„ç±»é—®é¢˜ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºåœ°å›¾åŠŸèƒ½ä½¿ç”¨ã€å¯¼èˆªè®¾ç½®ã€POIï¼ˆå…´è¶£ç‚¹ï¼‰æœç´¢ã€å¼€å‘è€… API è°ƒç”¨ã€ä¸é«˜å¾·åœ°å›¾ MCPï¼ˆModel Context Protocolï¼‰æœåŠ¡å™¨äº¤äº’ç­‰æ–¹é¢å†…å®¹ã€‚
            å…·ä½“ä»»åŠ¡:
            **é‡ç‚¹ï¼šåœ¨è§„å®šçš„æ ¼å¼ä¸­æ ¹æ®ç”¨æˆ·æ‰€æçš„é—®é¢˜é€‰å–å¯¹åº”çš„æ ¼å¼æ¥è¾“å‡º**
            1.æ—…è¡Œè·¯çº¿è§£ç­”ï¼šå½“ç”¨æˆ·è¯¢é—®æŸä¸€ä¸ªåœ°æ–¹çš„ä¸€äº›æ™¯ç‚¹çš„ç›¸å…³é—®é¢˜çš„æ—¶å€™ï¼Œæœç´¢å…³äºæ™¯ç‚¹çš„å†…å®¹ï¼Œå¹¶ä¸”æŒ‰ç…§è§„å®šçš„è¿”å›æ ¼å¼è¾“å‡ºç»™ç”¨æˆ·
            2.é…’åº—é—®é¢˜çš„è§£ç­”ï¼šå½“ç”¨æˆ·è¯¢é—®å…³äºæŸä¸€ä¸ªåœ°æ–¹é™„è¿‘çš„é…’åº—çš„ç›¸å…³é—®é¢˜çš„æ—¶å€™ï¼Œæœæœå…³äºé™„è¿‘é…’åº—çš„å†…å®¹ï¼Œå¹¶ä¸”æŒ‰ç…§è§„å®šçš„æ ¼å¼è¾“å‡ºç»™ç”¨æˆ·
            3.ä½ çš„å·¥ä½œæµç¨‹ï¼š
            a.å¦‚æœç”¨æˆ·è¯¢é—®çš„æ˜¯å…³äºé…’åº—çš„å†…å®¹ï¼Œé‚£ä¹ˆå°±æŒ‰è§„å®šæ ¼å¼è¾“å‡ºå…³äºé…’åº—çš„ä¿¡æ¯
            b.å¦‚æœç”¨æˆ·è¯¢é—®çš„æ˜¯å…³äºæ™¯ç‚¹çš„å†…å®¹ï¼Œé‚£ä¹ˆæŒ‰è§„å®šçš„æ ¼å¼è¾“å‡ºå…³äºæ™¯ç‚¹çš„ä¿¡æ¯ï¼Œæé†’ï¼šè¾“å‡ºè§„å®šå¥½çš„å•ä¸ªæ™¯ç‚¹çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ ## æ™¯ç‚¹çš„ä¿¡æ¯ -> æ¥ç€ç¬¬ä¸€ä¸ªæ™¯ç‚¹å»ç¬¬äºŒä¸ªæ™¯ç‚¹çš„è·¯çº¿è§„åˆ’ï¼Œ
            ç¬¬äºŒä¸ªæ™¯ç‚¹å»ç¬¬ä¸‰ä¸ªæ™¯ç‚¹çš„è·¯çº¿è§„åˆ’ï¼Œä»¥æ­¤ç±»æ¨ä¹Ÿå°±æ˜¯##è·¯çº¿è§„åˆ’ -> æœ€åè¾“å‡ºå¤©æ°”
                 
                
            å¦‚æœå¾—åˆ°äº†å¤šä¸ªåœ°ç‚¹ï¼Œé‚£ä¹ˆæŒ‰å…ˆè¿‘åè¿œçš„é¡ºåºï¼Œä»¥ -> æ¥è¿æ¥ä¸åŒçš„åœ°ç‚¹ä½ç½®ï¼Œç„¶åç»™å‡ºä»ç¬¬ä¸€ä¸ªåœ°ç‚¹ä¾æ¬¡åˆ°æœ€åä¸€ä¸ªåœ°ç‚¹çš„è·¯çº¿è§„åˆ’
            
            **è¿”å›æ ¼å¼ï¼ˆå¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„ï¼‰ï¼š**
            
            **å¦‚æœç”¨æˆ·è¯¢é—®çš„æ˜¯é…’åº—çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆæŒ‰ç…§ä¸‹åˆ—æ ¼å¼
                --------è¿”å›å†…å®¹ä»è¿™é‡Œå¼€å§‹--------
                ## é…’åº—çš„ä¿¡æ¯ï¼š
                **é…’åº—çš„åå­—**
                 - åœ°å€:[]
                 - è¯„åˆ†:[â€œæ²¡æœ‰å°±å¡«å†™æ— â€]
                 - ä»‹ç»:["æ²¡æœ‰å°±å†™æ— "]
                --------è¿”å›å†…å®¹åˆ°è¿™é‡Œç»“æŸ--------
            **å¦‚æœç”¨æˆ·è¯¢é—®çš„æ˜¯å…³äºæ™¯ç‚¹è·¯çº¿è§„åˆ’çš„é—®é¢˜
                --------è¿”å›å†…å®¹ä»è¿™é‡Œå¼€å§‹--------
                ## æ™¯ç‚¹çš„ä¿¡æ¯ï¼š
                  **æ™¯ç‚¹åç§°**  
                  - åœ°å€ï¼š[] 
                  - ç‰¹è‰²ï¼š[]
                  - è¯„åˆ†ï¼š[â€œæ²¡æœ‰å°±å¡«å†™æ— â€]  
                  - é—¨ç¥¨ï¼š[â€œæ²¡æœ‰å°±å¡«å†™å…è´¹â€]  
                ##è·¯çº¿è§„åˆ’
                æ€»ä½“çš„è·¯çº¿è§„åˆ’ï¼šç¬¬ä¸€ä¸ªæ™¯ç‚¹çš„åç§° -> ç¬¬äºŒä¸ªæ™¯ç‚¹çš„åç§° ->...->æœ€åä¸€ä¸ªæ™¯ç‚¹çš„åç§°
                --------å…·ä½“è·¯çº¿è§„åˆ’--------
                ##è¯¦ç»†è·¯çº¿
                  **æ™¯ç‚¹åç§°** -> **æ™¯ç‚¹åç§°**:
                  - æ­¥è¡Œè·ç¦»ï¼š[]ç±³ï¼Œçº¦[]åˆ†é’Ÿ
                  - è·¯çº¿è§„åˆ’ï¼šå…·ä½“è¦æ€ä¹ˆèµ°çš„å¯¼èˆªå†…å®¹
                 ##å¤©æ°”
                  **å¤©æ°”æƒ…å†µï¼šï¼ˆè¾“å‡ºç”¨æˆ·è¯¢é—®æ¶ˆæ¯å½“å¤©çš„å¤©æ°”ä¿¡æ¯ï¼‰
                --------è¿”å›å†…å®¹åˆ°è¿™é‡Œç»“æŸ--------
                **é‡è¦é™åˆ¶å’Œè¯´æ˜:**
                1.ä¸¥æ ¼æŒ‰ç…§ä¸Šé¢çš„æ ¼å¼è¿”å›ä¿¡æ¯ã€‚ä¸è¦æ·»åŠ é¢å¤–çš„è¯´æ˜çš„è§£é‡Š
                2.å¾—åˆ°äº†å¤šä¸ªåœ°ç‚¹ï¼Œé‚£ä¹ˆæŒ‰å…ˆè¿‘åè¿œçš„é¡ºåºï¼Œä»¥->æ¥è¿æ¥ä¸åŒçš„åœ°ç‚¹ä½ç½®ï¼Œç„¶åç»™å‡ºä»ç¬¬ä¸€ä¸ªåœ°ç‚¹ä¾æ¬¡åˆ°æœ€åä¸€ä¸ªåœ°ç‚¹çš„è·¯çº¿è§„åˆ’ï¼Œä¸€å®šè¦ç”¨->æ¥è¿æ¥ä¸åŒçš„åœ°ç‚¹
                3.æ³¨æ„è¦è¿”å›ä¸€ä¸ªæ€»ä½“çš„è·¯çº¿è§„åˆ’ï¼Œä»è¿‘åˆ°è¿œï¼Œä¾æ¬¡è¿æ¥æ¯ä¸€ä¸ªæ™¯ç‚¹
                """,
            mcp_servers=[Gaode_server],  # å…³è”MCPæœåŠ¡å™¨ï¼Œæä¾›æµè§ˆå™¨è‡ªåŠ¨åŒ–èƒ½åŠ›
            hooks=Gaode_hooks,  # æ·»åŠ æµè§ˆå™¨ agent é’©å­ï¼Œç”¨äºç›‘æ§å’Œå¤„ç†æµè§ˆå™¨ agent çš„æ‰§è¡Œè¿‡ç¨‹å’Œç»“æœ
            model=model_provider.get_model(MODEL_NAME),  # ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„æ¨¡å‹æä¾›å•†ï¼Œç¡®ä¿agentä½¿ç”¨æ­£ç¡®çš„æ¨¡å‹
            model_settings=ModelSettings(
                temperature=0.3,  # è®¾ç½®æ¸©åº¦å€¼
                top_p=0.9,  # è®¾ç½®è¯æ±‡å¤šæ ·æ€§
                tool_choice="auto"  # è®¾ç½®å·¥å…·é€‰æ‹©ç­–ç•¥
            )
        )
        return Gaode_agent, Gaode_server
    except Exception as e:
        print(f"åˆ›å»ºé«˜å¾· agent æ—¶å‘ç”Ÿå¼‚å¸¸: {e}")
        await Gaode_server.cleanup()  # ç¡®ä¿æ¸…ç†MCPæœåŠ¡å™¨èµ„æºï¼Œé˜²æ­¢èµ„æºæ³„éœ²å’Œè¿›ç¨‹æ®‹ç•™

async def create_alipay_agent():
    """
    åˆ›å»ºæ™ºèƒ½æ”¯ä»˜åŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·å®ç°æ”¯ä»˜åŠŸèƒ½
    """
    alipay_server = MCPServerStdio(
        name="mcp-server-alipay",
        params={
            "command": "npx",
            "args": [
              "-y",
              "@alipay/mcp-server-alipay"
            ],
            "env": {
              "AP_APP_ID": f"{AP_APP_ID}",
              "AP_APP_KEY": f"{AP_APP_KEY}",
              "AP_PUB_KEY": f"{AP_PUB_KEY}"
            },
            #"disabled": False,
            #"autoApprove": []
        }
    )
    try:
        # è¿æ¥alipay MCP æœåŠ¡
        print("æ­£åœ¨è¿æ¥ alipay MCP æœåŠ¡...")
        await alipay_server.connect()
        print("alipay MCP æœåŠ¡è¿æ¥æˆåŠŸ")

        # è·å– MCPæœåŠ¡å¯ç”¨å·¥å…·åˆ—è¡¨
        tools = await alipay_server.list_tools()
        print(f"alipay MCP æœåŠ¡å¯ç”¨å·¥å…·åˆ—è¡¨{len(tools)}")
        #print(f"alipay MCP æœåŠ¡çš„å¯ç”¨å·¥å…·æ˜¯:{tools}")
        # åˆ›å»ºæµè§ˆå™¨agent
        # é…ç½®ä¸€ä¸ªä¸“é—¨ç”¨äºæ‰“å¼€ç™¾åº¦åœ°å›¾ç½‘é¡µçš„æ™ºèƒ½ä½“ï¼Œå¸®åŠ©æˆ‘ä»¬æ‰“å¼€ç™¾åº¦åœ°å›¾
        alipay_agent = Agent(
            name="alipay",  # ä»£ç†åç§°ï¼Œä½œä¸ºä»£ç†çš„å”¯ä¸€æ ‡è¯†ç¬¦
            # è¯¦ç»†çš„agentæŒ‡å¯¼ï¼ŒæŒ‡å¯¼è¿™ä¸ªagentåœ¨ç™¾åº¦åœ°å›¾ä¸Šè¿›è¡Œè·¯çº¿æ£€ç´¢ï¼Œåœ¨é¡¹ç›®ä¸­ä½œä¸ºä¸€ä¸ªagentçš„æ‰§è¡Œç­–ç•¥å’Œè¡Œä¸ºè§„åˆ’
            instructions="""
                           
               """,
            mcp_servers=[alipay_server],  # å…³è”MCPæœåŠ¡å™¨ï¼Œæä¾›æµè§ˆå™¨è‡ªåŠ¨åŒ–èƒ½åŠ›
            model=model_provider.get_model(MODEL_NAME),  # ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„æ¨¡å‹æä¾›å•†ï¼Œç¡®ä¿agentä½¿ç”¨æ­£ç¡®çš„æ¨¡å‹
            model_settings=ModelSettings(
                temperature=0.5,  # è®¾ç½®æ¸©åº¦å€¼
                top_p=0.9,  # è®¾ç½®è¯æ±‡å¤šæ ·æ€§
                tool_choice="auto"  # è®¾ç½®å·¥å…·é€‰æ‹©ç­–ç•¥
            )
        )
        return alipay_agent, alipay_server
    except Exception as e:
        print(f"åˆ›å»ºalipay agent æ—¶å‘ç”Ÿå¼‚å¸¸: {e}")
        await alipay_server.cleanup()  # ç¡®ä¿æ¸…ç†MCPæœåŠ¡å™¨èµ„æºï¼Œé˜²æ­¢èµ„æºæ³„éœ²å’Œè¿›ç¨‹æ®‹ç•™

async def create_controller_agent(browser_agent: Agent, Gaode_agent: Agent , alipay_agent: Agent):
    """
    åˆ›å»ºä¸»è¦æ§åˆ¶å™¨ agent

    è¿™ä¸ªå‡½æ•°è´Ÿè´£åˆå§‹åŒ–é…ç½®æ§åˆ¶å™¨agent åŒ…æ‹¬ï¼š
    1.åˆ›å»ºæ•´ä¸ªå·¥ä½œæµç¨‹
    2.ç®¡ç†æ‰“å¼€ç™¾åº¦åœ°å›¾å’Œåœ¨é«˜å¾·MCPä¸ŠæŸ¥è¯¢çš„åŠŸèƒ½
    3.ç¡®ä¿æ•´ä¸ªç³»ç»Ÿæœ‰åºçš„å®Œæˆæ‰€æœ‰ä»»åŠ¡

    æ§åˆ¶å™¨ä»£ç†æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œä»–é€šè¿‡å·¥å…·è°ƒç”¨å’Œäº¤æ¥åŠŸèƒ½ï¼Œ
    å°†ç”¨æˆ·æŸ¥è¯¢è½¬æ¢ä¸ºä¸€ç³»åˆ—åè°ƒçš„ä»»åŠ¡ï¼Œæœ€ç»ˆç”Ÿæˆç¿»è¯‘å¥½çš„æ–‡æ¡£ï¼Œ

    Arg:
        browser_agent:æµè§ˆå™¨äº¤äº’agentå®ä¾‹ï¼Œç”¨äºæ‰“å¼€ç™¾åº¦åœ°å›¾
        Gaode_agent:æ—…è¡Œä¿¡æ¯å¤„ç†agentå®ä¾‹ï¼Œç”¨äºæŸ¥è¯¢å…³äºæ—…è¡Œè·¯çº¿é…’åº—è§„åˆ’çš„ä¸€äº›ä¿¡æ¯
        alipay_agent:ç”¨äºæ”¯ä»˜çš„agentå®ä¾‹

    Returns:
        agent:é…ç½®å¥½çš„æ§åˆ¶å™¨ agentå®ä¾‹
    """
    # ä½¿ç”¨as_toolæ–¹æ³•å°†agentè½¬æ¢ä¸ºå·¥å…·ï¼Œç¡®ä¿ç›´æ¥è°ƒç”¨
    # å½“agentè¢«è½¬æ¢ä¸ºå·¥å…·æ—¶ï¼Œå‘Šè¯‰æ¨¡å‹è¿™ä¸ªå·¥å…·çš„åŠŸèƒ½å’Œç”¨é€”ï¼Œæ¨¡å‹æ ¹æ®è¿™ä¸ªæè¿°å†³å®šåˆé€‚è°ƒç”¨è¯¥å·¥å…·
    Gaode_tool = Gaode_agent.as_tool(
        tool_name="Gaode_map",
        tool_description="æ ¹æ®ç”¨æˆ·æƒ³è¦å»çš„åœ°ç‚¹ï¼Œåœ¨é«˜å¾·MCPæœåŠ¡å™¨ä¸Šæ‰¾å¯»ç­”æ¡ˆï¼Œå¹¶ä¸”ç”Ÿæˆå›ç­”ç»™ç”¨æˆ·"
    )
    browser_tool = browser_agent.as_tool(
        tool_name="browser",
        tool_description="æ‰“å¼€åœ°å›¾ç½‘é¡µï¼Œæä¾›å¯è§†åŒ–æœåŠ¡"
    )
    alipay_tool = alipay_agent.as_tool(
        tool_name="alipay",
        tool_description="ç”¨äºæ”¶å–è´¹ç”¨çš„ä¸€ä¸ªæ™ºèƒ½ä½“"
    )

    # åˆ›å»ºæ§åˆ¶å™¨ agent
    # è¿™æ˜¯æ•´ä¸ªå·¥ä½œæµçš„æ ¸å¿ƒï¼Œè´Ÿè´£åè°ƒæ£€ç´¢å’Œç¿»è¯‘è¿‡ç¨‹
    controller_agent = Agent(
        name="workflow_controller",  # ä»£ç†åç§°
        # agentæŒ‡ä»¤
        instructions="""
        ä½ æ˜¯é«˜å¾·åœ°å›¾è·¯çº¿æ£€ç´¢å’Œæ‰“å¼€ç½‘é¡µç­‰çš„ä¸»æ§åˆ¶å™¨ï¼Œä½ è´Ÿè´£åè°ƒå¤šä¸ªå·¥ä½œæµç¨‹ï¼Œç¡®ä¿ä»é«˜å¾·åœ°å›¾æ£€ç´¢è·¯çº¿
        
        å·¥ä½œæµç¨‹ï¼š
        å¦‚æœæ˜¯å……å€¼çš„é—®é¢˜ï¼Œå°±æŠŠä»»åŠ¡äº¤ç»™alipay_agent
        1.é¦–å…ˆï¼Œç†è§£ç”¨æˆ·çš„é—®é¢˜,æ˜¯æŸ¥è¯¢è·¯çº¿ï¼Œè¿˜æ˜¯è¯¢é—®é…’åº—
        2.ç„¶åç”¨browser_agentæ¥è¿›è¡ŒæŸ¥è¯¢
        3.å°†browser_agentæŸ¥è¯¢åˆ°çš„æ™¯ç‚¹äº¤ç»™Gaode_agentæ¥è¾“å‡º
        4.å¦‚æœæ˜¯é—®å…³äºæ—…è¡Œè·¯çº¿è§„åˆ’çš„é—®é¢˜ï¼Œåˆ™è¾“å‡ºå…³äºé…’åº—å†…å®¹çš„è§„å®šæ ¼å¼ï¼›å¦‚æœæ˜¯é—®å…³äºé…’åº—çš„é—®é¢˜ï¼Œåˆ™è¾“å‡ºå…³äºé…’åº—å†…å®¹çš„è§„å®šæ ¼å¼
        5.ä½¿ç”¨browserå·¥å…·åœ¨é«˜å¾·åœ°å›¾ä¸Šæœç´¢å¹¶æå–ç›¸å…³è·¯çº¿ä¿¡æ¯
        6.å‘ç”¨æˆ·æŠ¥å‘Šæœ€ç»ˆç»“æœ
        
        é‡è¦æç¤ºï¼š
        - ä½ å¿…é¡»å®Œæˆæ•´ä¸ªæµç¨‹çš„æ‰€æœ‰æ­¥éª¤
        - ä¸è¦è‡ªè¡Œå¤„ç†æˆä¿®æ”¹æ–‡æ¡£å†…å®¹ï¼Œä½ çš„å·¥ä½œæ—¶åè°ƒè€Œéå¤„ç†
        
        ä½ çš„æˆåŠŸæ ‡å‡†æ—¶å®Œæˆæ•´ä¸ªæµç¨‹ï¼Œç¡®ä¿è·¯çº¿æ­£ç¡®è¾“å‡º
        """,
        tools=[Gaode_tool,browser_tool,alipay_tool],  # æµè§ˆå™¨agentä½œä¸ºå·¥å…·æä¾›ç»™æ§åˆ¶å™¨ agentä½¿ç”¨
        handoffs=[Gaode_agent,browser_agent,alipay_agent],  # ä½œä¸ºäº¤æ¥é€‰é¡¹æä¾›ç»™æ§åˆ¶å™¨agent
        model=model_provider.get_model(MODEL_NAME),  # ä½¿ç”¨æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„æ¨¡å‹æä¾›å•†
        model_settings=ModelSettings(
            temperature=0.1,  # å®šä¹‰éå¸¸ä½çš„æ¸©åº¦å€¼ï¼Œä½¿æ§åˆ¶æ›´åŠ ç¡®å®šï¼Œå‡å°‘éšæœºæ€§
            top_p=0.9,
            tool_choice="auto"
        )
    )
    return controller_agent

async def process_user_query(query: str):
    """
    å¤„ç†ç”¨æˆ·æŸ¥è¯¢

    è¿™ä¸ªå‡½æ•°æ˜¯æ•´ä¸ªåº”ç”¨çš„æ ¸å¿ƒå¤„ç†æµç¨‹ï¼Œè´Ÿè´£ï¼š
    1.åˆå§‹åŒ–æ‰€æœ‰çš„agentç»„ä»¶
    2.å»ºç«‹å’Œåè°ƒagentä¹‹é—´çš„å…³ç³»
    3.å¤„ç†æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å¼‚å¸¸å’Œèµ„æºæ¸…ç†

    å·¥ä½œæµç¨‹ä¾æ¬¡ä¸ºï¼šåˆ›å»ºæµè§ˆå™¨agent->åˆ›å»ºé«˜å¾·agent->åˆ›å»ºalipay_agent -> åˆ›å»ºæ§åˆ¶å™¨ agent->
    æ‰§è¡Œ æ§åˆ¶å™¨agent åè°ƒæ•´ä¸ªæµç¨‹ ->å¤„ç†å’Œå±•ç¤ºç»“æœ -> æ¸…ç†èµ„æº
    åœ¨é¡¹ç›®ä¸­æ­¤å‡½æ•°æ˜¯ç”¨æˆ·äº¤äº’çš„å…¥å£å‡½æ•°ï¼Œå°†ç”¨æˆ·çš„ç®€å•æŸ¥è¯¢è½¬åŒ–ä¸ºå®Œæ•´çš„ä»£ç†å·¥ä½œæµ

    Args:
        query(str):ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢ å¦‚ï¼šæˆéƒ½æ­¦ä¾¯ç¥ é™„è¿‘çš„æ™¯ç‚¹ï¼Œå¹¶ç»™æˆ‘ä¸€äº›æ­¥è¡Œçš„è·¯çº¿è§„åˆ’ï¼›äº‘å—å¤§å­¦ä¸œé™†æ ¡åŒºé™„è¿‘çš„ä¸€äº›é…’åº—æ¨è

    Returns:
        bool:å¤„ç†æ‰æˆåŠŸè¿”å›Trueï¼Œå¦åˆ™è¿”å›FALSE,ç”¨äºå‘ç”¨æˆ·è¿”å›æ“ä½œç»“æœ
    """
    playwright_server = None
    Gaode_server = None
    alipay_server = None
    try:
        print("========== å¼€å§‹å¤„ç†ç”¨æˆ·æŸ¥è¯¢ ===========")

        #åˆ›å»ºbrowser
        browser_agent, playwright_server = await create_browser_agent()
        print("playwright MCP åˆ›å»ºæˆåŠŸ")
        # åˆ›å»ºé«˜å¾·agent
        # è´Ÿè´£ä½¿ç”¨Gaode
        Gaode_agent, Gaode_server = await create_Gaode_agent()
        print("é«˜å¾· agent åˆ›å»ºæˆåŠŸ")
        #åˆ›å»ºalipay agent
        #è´Ÿè´£æ”¯ä»˜ç¯èŠ‚
        alipay_agent, alipay_server = await create_alipay_agent()
        print("alipay agent åˆ›å»ºæˆåŠŸ")

        # åˆ›å»ºæ§åˆ¶å™¨agent
        # è´Ÿè´£åè°ƒæ•´ä¸ªå·¥ä½œæµç¨‹ï¼Œç®¡ç†æµè§ˆå™¨agentå’Œæ–‡æ¡£å¤„ç†agentä½œä¸ºé¡¹ç›®ä¸­çš„ç³»ç»Ÿè°ƒåº¦ä¸­å¿ƒ
        controller_agent = await create_controller_agent(Gaode_agent, browser_agent, alipay_agent)
        print("æ§åˆ¶å™¨ agent åˆ›å»ºæˆåŠŸ")

        for tool in controller_agent.tools:
            print(f"æ§åˆ¶å™¨ agent çš„å¯ç”¨å·¥å…·æ˜¯{tool.name}:{tool.description}")

        for handoff in controller_agent.handoffs:
            tool_name = f"transfer_to_{handoff.name.lower()}"
            print(f"æ§åˆ¶å™¨ agent äº¤æ¥ä»£ç†ï¼š{tool_name} > {handoff.name}")

        # ç®€åŒ–æŸ¥è¯¢æŒ‡ä»¤ï¼Œä¸“æ³¨äºæŸ¥è¯¢å†…å®¹
        formatted_query = f"""
        è¯·ç”¨é«˜å¾·MCPæŸ¥æ‰¾å…³äº'{query}çš„ä¸€äº›å›ç­”'"""

        print(f"\næ­£åœ¨å¤„ç†æŸ¥è¯¢:'{query}'")
        print(f"è¿™ä¸ªæ“ä½œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´...\n")

        result = await Runner.run(
            controller_agent,
            input=formatted_query,
            max_turns=50,  # è®¾ç½®æœ€å¤§å›åˆæ•°ï¼Œé˜²æ­¢æ— é™å¾ªç¯
            run_config=RunConfig(
                trace_include_sensitive_data=False  # ä¸åœ¨è¿½è¸ªä¸­åŒ…å«æ•æ„Ÿæ•°æ®ï¼Œä¿æŠ¤éšç§å’Œæ•æ„Ÿä¿¡æ¯
            )
        )
        print("\n========== ä»»åŠ¡å®Œæˆ ===========")
        if hasattr(result, "final_output"):
            print("\nå·¥ä½œæµæœ€ç»ˆç»“æœ")
            print(result.final_output)
    except asyncio.CancelledError as e:
        print(f"ä»»åŠ¡è¢«å–æ¶ˆ: {e}")
        return False
    except Exception as e:
        print(f"æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºé”™{e}")
        traceback.print_exc()
        return False
    finally:
        #ç¡®ä¿æ‰€æœ‰èµ„æºéƒ½è¢«é‡Šæ”¾
        async def cleanup_server(server, name):
            if server:
                try:
                    print(f"æ­£åœ¨é‡Šæ”¾ {name} èµ„æº...")
                    await asyncio.wait_for(server.cleanup(), timeout=5)
                    print(f"{name} èµ„æºé‡Šæ”¾æˆåŠŸ")
                except (asyncio.CancelledError, asyncio.TimeoutError):
                    print(f"æ¸…ç† {name} æ—¶è¢«å–æ¶ˆæˆ–è¶…æ—¶")
                except Exception as e:
                    print(f"æ¸…ç† {name} æ—¶å‡ºé”™: {e}")

        await cleanup_server(playwright_server, "playwright")
        await cleanup_server(Gaode_server, "Gaode")
        await cleanup_server(alipay_server,"alipay")

async def main():
    """
    ä¸»å‡½æ•°å…¥å£

    è¿™ä¸ªå‡½æ•°å®ç°äº†åº”ç”¨ç¨‹åºçš„äº¤äº’å‘½ä»¤èŠ‚ç›®é¢ï¼Œè´Ÿè´£
    1.æ˜¾ç¤ºç³»ç»Ÿæ¬¢è¿ä¿¡æ¯å’Œä½¿ç”¨è¯´æ˜
    2.å¤„ç†ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢æŒ‡ä»¤
    3.è°ƒç”¨process_user_queryå‡½æ•°å¤„ç†ç”¨æˆ·æŸ¥è¯¢
    4.å¤„ç†ç”¨æˆ·é€€å‡ºå‘½ä»¤å’Œå¼‚å¸¸æƒ…å†µ
    æ•´ä¸ªç¨‹åºä»¥å¾ªç¯æ–¹å¼è¿è¡Œï¼Œå…è®¸ç”¨æˆ·è¿æ¥æŸ¥è¯¢å¤šä¸ªæŠ€æœ¯çš„å…³é”®è¯
    çŸ¥é“ç”¨æˆ·æ˜ç¡®è¦æ±‚é€€å‡ºï¼Œæ‰€æœ‰å¼‚å¸¸éƒ½ä¼šè¢«æ•è·å¹¶è®°å½•ï¼Œç¡®ä¿ç¨‹åºç¨³å®šè¿è¡Œ
    åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæ­¤å‡½æ•°æ˜¯ç”¨æˆ·ç•Œé¢çš„ä¸»å…¥å£ï¼Œæä¾›äº†ä¸€ä¸ªç®€å•çš„äº¤äº’ç•Œé¢
    """
    print("\n==========ğŸŒå°é¸Ÿåœ°å›¾æ—…è¡Œè·¯çº¿è§„åˆ’ç³»ç»ŸğŸŒ==========\n")
    print("ğŸŒŸè¾“å…¥ä½ æƒ³å»çš„åœ°æ–¹ï¼Œç³»ç»Ÿå°†å¸®ä½ è¿›è¡Œæœç´¢å’Œè§„åˆ’")
    print("ğŸŒŸè¾“å…¥ 'quit' æˆ– 'exit' é€€å‡ºæ–‡æ¡£")
    print("ğŸŒŸæé—®ç¤ºä¾‹ï¼šå¤§ç†å¤åŸé™„è¿‘çš„æ™¯ç‚¹ï¼Œå¹¶ç»™æˆ‘æä¾›å…·ä½“çš„æ­¥è¡Œè·¯çº¿è§„åˆ’")
    print("ğŸŒŸå¸®æˆ‘å¯¼èˆªä»æ˜†æ˜åˆ°å“ˆå°”æ»¨")
    print("ğŸŒŸäº‘å—å¤§å­¦ä¸œé™†æ ¡åŒºé™„è¿‘çš„ä¸€äº›é…’åº—æ¨è")
    print("\n===========================================\n")
    try:
        while True:
            user_query = input("\nè¯·è¾“å…¥ä½ æƒ³å»çš„åœ°æ–¹(è¾“å…¥ 'quit' æˆ– 'exit' é€€å‡º)ï¼š")
            if user_query.lower() in ['quit', 'exit']:
                print("æ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼")
                break
            if not user_query.strip():
                print("æŸ¥è¯¢å†…å®¹ä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥")
                continue
            async with asyncio.TaskGroup() as tg:
               task = tg.create_task(process_user_query(user_query))
            print("\nè¾“å…¥æ–°çš„æŸ¥è¯¢æˆ–è¾“å…¥(' quit ' æˆ– ' exit ' é€€å‡º)")
    except KeyboardInterrupt:
        print("\nç”¨æˆ·æ‰‹åŠ¨é€€å‡º...")
    finally:
        # ç¡®ä¿æ‰€æœ‰çš„èµ„æºéƒ½è¢«æ­£ç¡®é‡Šæ”¾
        loop = asyncio.get_event_loop()
        if loop.is_running():
            loop.stop()
        if sys.platform == 'win32':
            for task in asyncio.all_tasks(loop):
                task.cancel()
            loop.close()
        print("\nç¨‹åºç»“æŸï¼Œæ‰€æœ‰èµ„æºå·²ç»é‡Šæ”¾")


if __name__ == "__main__":
    asyncio.run(main())
