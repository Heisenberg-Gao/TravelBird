<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Bird(æ—…è¡Œé¸Ÿ)-è§„åˆ’ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/style.css">

    <!-- å®‰å…¨å¯†é’¥é…ç½®ï¼ˆ2021å¹´12æœˆåç”³è¯·çš„Keyå¿…é¡»é…ç½®ï¼‰ -->
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "9413257cc6533f2b3950a1f4e7c11fe4" // æ›¿æ¢ä¸ºå®é™…å®‰å…¨å¯†é’¥
        };
    </script>

    <!-- é«˜å¾·åœ°å›¾Loader -->
    <script src="https://webapi.amap.com/loader.js"></script>
    <style>
        /* åœ°å›¾ä¸ç»“æœé¢æ¿å¸ƒå±€ */
        .map-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }

        #mapContainer {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="main-title">
            <span class="icon">ğŸ¦</span>
            Travel Bird(æ—…è¡Œé¸Ÿ)-è§„åˆ’ç³»ç»Ÿ
        </h1>

        <div class="section-divider">
            <div class="divider-line"></div>
            <span class="divider-text">æ™ºèƒ½è·¯çº¿è§„åˆ’ç³»ç»Ÿ</span>
            <div class="divider-line"></div>
        </div>

        <div class="instruction-box gradient-bg">
            <div class="instruction-header">
                <span class="icon">ğŸ—ºï¸</span>
                <h2>ä½¿ç”¨æŒ‡å—</h2>
            </div>
            <div class="example-list">
                <div class="example-item">
                    <span class="bullet">âœ¨</span>
                    <button onclick="fillAndSimulate('å¤§ç†å¤åŸé™„è¿‘çš„æ™¯ç‚¹æ­¥è¡Œè·¯çº¿è§„åˆ’')">å¤§ç†å¤åŸé™„è¿‘çš„æ™¯ç‚¹æ­¥è¡Œè·¯çº¿è§„åˆ’</button>
                </div>
                <div class="example-item">
                    <span class="bullet">ğŸš—</span>
                    <button onclick="fillAndSimulate('ç¿ æ¹–é™„è¿‘çš„æ™¯ç‚¹')">ç¿ æ¹–é™„è¿‘çš„æ™¯ç‚¹</button>
                </div>
                <div class="example-item">
                    <span class="bullet">ğŸ¨</span>
                    <button onclick="fillAndSimulate('äº‘å—å¤§å­¦ä¸œé™†æ ¡åŒºé™„è¿‘é…’åº—æ¨è')">äº‘å—å¤§å­¦ä¸œé™†æ ¡åŒºé™„è¿‘é…’åº—æ¨è</button>
                </div>
            </div>
        </div>

        <form id="queryForm">
            <div class="input-group">
                <input type="text" id="query" name="query"
                       placeholder="è¯·è¾“å…¥ç›®çš„åœ°ï¼Œä¾‹å¦‚ï¼šåŒ—äº¬æ•…å®«é™„è¿‘çš„æ™¯ç‚¹è·¯çº¿è§„åˆ’" required>
                <button type="submit" id="submitButton">å¼€å§‹è§„åˆ’</button>
            </div>
        </form>

        <div id="loading" class="loading" style="display:none;">
            <div class="loader"></div>
            <p>æ­£åœ¨åŠªåŠ›è§„åˆ’è·¯çº¿ä¸­...</p>
        </div>

        <div id="resultContainer" class="result-container" style="display:none;">
            <div id="resultContent"></div>
            <button onclick="resetForm()" class="back-btn">é‡æ–°è§„åˆ’</button>
            <!-- æ–°å¢é‡ç½®è·¯çº¿æŒ‰é’® -->
            <button onclick="resetRoute()" class="reset-route-btn">é‡ç½®è·¯çº¿</button>
        </div>

        <!-- åœ°å›¾å®¹å™¨ -->
        <div class="map-container">
            <div id="mapContainer"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        const submitButton = document.getElementById('submitButton');
        const queryInput = document.getElementById('query');
        const mapContainer = document.getElementById('mapContainer');
        let isSimulating = false;
        let map = null;
        let markers = [];
        let selectedMarkers = [];
        let driving;

        // æ¨¡æ‹Ÿç‚¹å‡»å‡½æ•°
        function simulateButtonClick() {
            if (isSimulating) return;
            isSimulating = true;
            const originalValue = queryInput.value;
            queryInput.value = 'æ­£åœ¨æœç´¢...';
            setTimeout(() => {
                queryInput.value = originalValue;
                submitButton.click();
                isSimulating = false;
            }, 1500);
        }

        // å¡«å……æœç´¢æ¡†å¹¶æ¨¡æ‹Ÿç‚¹å‡»
        function fillAndSimulate(query) {
            queryInput.value = query;
            simulateButtonClick();
        }

        // æå–åœ°ç‚¹å‡½æ•°
        function extractLocations(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, "text/html");
            const headingElements = doc.querySelectorAll("h4");
            const locations = Array.from(headingElements).map(el =>
                el.textContent.trim().replace(/\*\*/g, '')
            );
            const uniqueLocations = [...new Set(locations)];
            const invalidKeywords = [];
            return uniqueLocations.filter(location =>
                location.length > 1 && !invalidKeywords.includes(location)
            );
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('queryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = queryInput.value;
            const resultDiv = document.getElementById('resultContent');
            const loading = document.getElementById('loading');

            loading.style.display = 'block';
            resultDiv.innerHTML = '';
            mapContainer.style.display = 'none';

            // æ¸…é™¤ç°æœ‰æ ‡è®°
            if (map) {
                map.clearMap();
            }
            markers = [];
            selectedMarkers = [];

            try {
                // åŠ è½½é«˜å¾·åœ°å›¾APIåŠæ’ä»¶
                const AMap = await AMapLoader.load({
                    key: "45b628fd95a140a6dd86ec8d9e2d26aa", // æ›¿æ¢ä¸ºå®é™…Key
                    version: "2.0", // ä½¿ç”¨2.0ç‰ˆæœ¬API
                    plugins: ["AMap.Geocoder", "AMap.Driving"] // æŒ‰éœ€åŠ è½½åœ°ç†ç¼–ç å’Œé©¾è½¦è·¯çº¿è§„åˆ’æ’ä»¶
                });

                // åˆå§‹åŒ–åœ°å›¾
                map = new AMap.Map('mapContainer', {
                    zoom: 10,
                    center: [116.397428, 39.90923], // åŒ—äº¬é»˜è®¤ä¸­å¿ƒ
                    resizeEnable: true, // æ”¯æŒçª—å£ç¼©æ”¾
                    mapStyle: 'amap://styles/normal' // æ ‡å‡†åœ°å›¾æ ·å¼
                });
                mapContainer.style.display = 'block';

                // åˆå§‹åŒ–é©¾è½¦è·¯çº¿è§„åˆ’æ’ä»¶
                driving = new AMap.Driving({
                    map: map,
                    panel: "resultContent"
                });

                // å‘é€åç«¯è¯·æ±‚
                const response = await fetch('/process_query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `query=${encodeURIComponent(query)}`
                });
                const data = await response.json();

                if (data.error) {
                    resultDiv.innerHTML = `<div class="error">${data.error}</div>`;
                } else if (data.html_content) {
                    resultDiv.innerHTML = data.html_content;
                    const extractedLocations = extractLocations(data.html_content);
                    console.log("æå–çš„åœ°ç‚¹:", extractedLocations);

                    // ä¸ºæ‰€æœ‰æå–çš„åœ°ç‚¹åˆ›å»ºæ ‡è®°ï¼ˆæ¯ä¸ªå…³é”®è¯åªå¯¹åº”ä¸€ä¸ªç‚¹ï¼‰
                    createMarkersForLocations(extractedLocations);
                } else {
                    resultDiv.innerHTML = "æœªæ‰¾åˆ°ç›¸å…³ç»“æœ";
                }

                // æ˜¾ç¤ºç»“æœå®¹å™¨
                document.getElementById('resultContainer').style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                console.error("ç³»ç»Ÿé”™è¯¯ï¼š", error);
                resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        });

        // åˆ›å»ºæ ‡è®°å‡½æ•° - ç¡®ä¿æ¯ä¸ªå…³é”®è¯åªåˆ›å»ºä¸€ä¸ªæ ‡è®°
        function createMarkersForLocations(locations) {
            // ä½¿ç”¨Setå»é‡ï¼Œé¿å…é‡å¤æœç´¢ç›¸åŒçš„å…³é”®è¯
            const uniqueLocations = [...new Set(locations)];

            uniqueLocations.forEach(location => {
                // ä½¿ç”¨AMap.Geocoderç›´æ¥è·å–åæ ‡ï¼Œæ¯”PlaceSearchæ›´ç²¾ç¡®
                AMap.plugin('AMap.Geocoder', function() {
                    const geocoder = new AMap.Geocoder({
                        city: "æ˜†æ˜"
                    });

                    geocoder.getLocation(location, function(status, result) {
                        if (status === 'complete' && result.info === 'OK') {
                            if (result.geocodes && result.geocodes.length > 0) {
                                // åªå–ç¬¬ä¸€ä¸ªç»“æœåˆ›å»ºæ ‡è®°
                                const position = result.geocodes[0].location;
                                createSingleMarker(location, position);
                            } else {
                                console.warn(`æ— æ³•æ‰¾åˆ°åœ°ç‚¹: ${location}`);
                            }
                        } else {
                            console.warn(`åœ°ç†ç¼–ç å¤±è´¥: ${location}`);
                        }
                    });
                });
            });
        }

        // åˆ›å»ºå•ä¸ªæ ‡è®°çš„è¾…åŠ©å‡½æ•°
        function createSingleMarker(location, position) {
            const marker = new AMap.Marker({
                position: position,
                title: location,
                map: map,
                icon: new AMap.Icon({
                    image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    size: new AMap.Size(25, 34)
                }),
                offset: new AMap.Pixel(-12, -34)
            });

            markers.push(marker);

            // åˆ›å»ºä¿¡æ¯çª—å£
            const infoWindow = new AMap.InfoWindow({
                content: `<div style="padding:5px;"><strong>${location}</strong></div>`,
                offset: new AMap.Pixel(0, -30)
            });

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            marker.on('click', function() {
                infoWindow.open(map, marker.getPosition());
                selectMarker(marker);
            });

            // è‡ªåŠ¨æ‰“å¼€ç¬¬ä¸€ä¸ªæ ‡è®°çš„ä¿¡æ¯çª—å£
            if (markers.length === 1) {
                setTimeout(() => {
                    infoWindow.open(map, marker.getPosition());
                }, 1000);
            }
        }

        // é€‰æ‹©æ ‡è®°ç‚¹
        function selectMarker(marker) {
            if (selectedMarkers.includes(marker)) {
                // å¦‚æœå·²ç»é€‰æ‹©ï¼Œå–æ¶ˆé€‰æ‹©
                const index = selectedMarkers.indexOf(marker);
                selectedMarkers.splice(index, 1);
                marker.setIcon(new AMap.Icon({
                    image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                    size: new AMap.Size(25, 34)
                }));
            } else {
                // å¦‚æœæœªé€‰æ‹©ï¼Œé€‰æ‹©è¯¥æ ‡è®°ç‚¹
                selectedMarkers.push(marker);
                marker.setIcon(new AMap.Icon({
                    image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png',
                    size: new AMap.Size(25, 34)
                }));
            }

            if (selectedMarkers.length === 2) {
                // å½“é€‰æ‹©äº†ä¸¤ä¸ªæ ‡è®°ç‚¹æ—¶ï¼Œè¿›è¡Œé©¾è½¦è·¯çº¿è§„åˆ’
                const start = selectedMarkers[0].getPosition();
                const end = selectedMarkers[1].getPosition();
                driving.search(start, end);
            }
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('queryForm').reset();
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('mapContainer').style.display = 'none';

            if (map) {
                map.clearMap();
                markers = [];
                selectedMarkers = [];
            }
        }

        // é‡ç½®è·¯çº¿
        function resetRoute() {
            if (map) {
                // æ¸…é™¤é©¾è½¦è·¯çº¿
                driving.clear();
                // é‡ç½®æ ‡è®°ç‚¹æ ·å¼
                selectedMarkers.forEach(marker => {
                    marker.setIcon(new AMap.Icon({
                        image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
                        size: new AMap.Size(25, 34)
                    }));
                });
                // æ¸…ç©ºå·²é€‰æ‹©çš„æ ‡è®°ç‚¹
                selectedMarkers = [];
            }
        }
    </script>
</body>

</html>

